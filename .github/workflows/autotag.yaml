name: Automated Tagging
on:
  push
  #schedule:
   # - cron: "00 12 */5 * *"

jobs:
  test_timestamp:
    name: Scheduled tag check
    runs-on: ubuntu-latest
    env:
      MODE: 'disabled'
      # smart: Auto Tag release every 5 days if no new commits
      # timed: Auto Tag release every 5 days
      # disabled: Auto Tag disable
    outputs:
      TIMESTAMP: ${{ steps.timestamp.outputs.TIMESTAMP }}
      TAG_PUSH: ${{ steps.set-mode.outputs.TAG_PUSH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: 'true'

      - name: Set timestamp
        id: timestamp
        run: |
          TIMESTAMP="$(git log -1 --format=%ct)"
          echo "TIMESTAMP=${TIMESTAMP}" >> ${GITHUB_OUTPUT}

      - name: Check Timestamp
        id: check-timestamp
        uses: actions/cache@v3
        with:
          path: last-timestamp
          key: last-timestamp-1735229957
          #${{ steps.timestamp.outputs.TIMESTAMP }}

      - name: Set mode
        id: 'set-mode'
        run: |
          if [ ${{ env.MODE }} == 'smart' ] \
          && [ ${{ steps.check-timestamp.outputs.cache-hit }} == 'true' ] \
          && [ -n "$(git tag -l --contains HEAD)" ]; then \
            TAG_PUSH=true; \
          fi
          
          if [ ${{ env.MODE }} == 'timed' ]; then \
            TAG_PUSH=true; \
          fi

          if [ ${{ env.MODE }} == 'disabled' ]; then \
            TAG_PUSH=false; \
          fi
          
          echo "TAG_PUSH=${TAG_PUSH}" >> ${GITHUB_OUTPUT}

      - name: Create cache file
        run: |
          if [ -f 'last-timestamp/timestamp.txt' ]; then \
            echo "Previous timestamp found";\
            PREV_TIMESTAMP="$( cat last-timestamp/timestamp.txt | tr -d "\n" )"; \
          else \
            PREV_TIMESTAMP=""; \
          fi
          echo "Previous ${PREV_TIMESTAMP}"
          if [ -z "${PREV_TIMESTAMP}" ] \
          || [ "${TIMESTAMP}" != "${PREV_TIMESTAMP}" ]; then \
            echo "Timestamp update..."; \
            mkdir -p last-timestamp; \
            TIMESTAMP="$(git log -1 --format=%ct)"; \
            echo "${TIMESTAMP}" > last-timestamp/timestamp.txt; \
          fi

  tag:
    name: Create Tag
    runs-on: ubuntu-latest
    needs: test_timestamp
    if: ${{ needs.test_timestamp.outputs.TAG_PUSH == 'true' }}
    steps:
      - uses: actions/checkout@v2
      - name: Create new tag
        run: |
          echo "Create Tag..."
          #git config --local user.email "action@github.com"
          #git config --local user.name "GitHub Action"
          #git tag -a "v${{ github.run_number }}" -m "Release v${{ github.run_number }}"
          #git push origin "v${{ github.run_number }}"

